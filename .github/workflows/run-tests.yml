name: Tests with Coverage Check

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Run Jest Tests
        run: yarn test --collectCoverage=false

  coverage:
    runs-on: ubuntu-latest
    needs: test  # This job will run only if the 'test' job succeeds
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --frozen-lockfile

      - name: Run Jest Coverage
        run: yarn test --coverage

      - name: Get Coverage Difference
        id: coverage-difference
        run: |
          echo "Previous Coverage:"
          previousCoverage=$(curl -s https://codecov.io/api/gh/$GITHUB_REPOSITORY/branch/main | jq '.commit.totals.c' )
          echo "$previousCoverage"
          echo "Current Coverage:"
          currentCoverage=$(cat ./coverage/lcov.info | yarn jest-coverage-badges -r lcov | grep -oP '(?<=coverage: )\d+')
          echo "$currentCoverage"
          echo "::set-output name=diff::$(echo "$previousCoverage" "$currentCoverage" | awk '{print ($2-$1)}')"

      - name: Fail if Coverage Decreased
        if: steps.coverage-difference.outputs.diff < 0
        run: |
          echo "ðŸ›‘ Coverage decreased!"
          exit 1

      - name: Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Coverage Summary
        run: |
          echo "âœ… Jest coverage passed with:"
          echo "$(cat ./coverage/lcov.info | yarn jest-coverage-badges -r lcov)"
          echo "View detailed coverage report on Codecov."
